<html>
<head>
<title>JSONLoops Basic HTML / JavaScript Control Interface</title>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/dnode.js"></script>
<script type="text/javascript">
  
    var r, theSong, sounds = [], socket, connecting, playing = false;

    $(window).load(function () {
      connectToServer();
      
      // jQuery UI events
      $('#play').click(function(){
        if (playing) {
          r.stop();
          playing = false;
        }
        else {
          r.start();
          playing = true;
        }
      });
      
      $('#addTrack').click(function(){
        addTrack();
      });
      
    });

    function connectToServer() {
      socket = DNode(function () {
          this.step = function (sequencer) {
            renderSequencer(sequencer);
          };
      }).connect(function (remote) {
        playing = true;
        r = remote;
      });
    }

    function renderSequencer(sequencer) {
      theSong = sequencer.song;
      $('#sequencer tr').remove();
      var position = sequencer.position,
      cnt = 0;
      for (var t = 0; t < sequencer.song.length; t++) {
        cnt = 0;
        // Create a new row in the table for every track
        $('#sequencer').append('<tr></tr>');
        
        // Create cells for each beat in that track
        for (var m = 0; m < sequencer.song[t].length; m++) {
          for (var b = 0; b < sequencer.song[t][m].length; b++) {
            cnt++;
            var beat = sequencer.song[t][m][b];
            if (!beat.length) {
              beat = '&nbsp;';
            }
            var style = "";
            if(cnt === position + 1) {
              style = "active"; 
            }
            $('#sequencer tr:last').append('<td class = ' + style + '>' + renderDropDown(beat, sounds) + '</td>');
          }
        }
      }
    }

    function renderDropDown(active, sounds) {
      
      return active;
      var html = '';
      
      html += '<select>';
      html += '<option>' + active + '</option>';
      
      sounds.forEach(function(v, i){
        html += '<option>' + v + '</option>';
      });
      
      html += '</select>';
      
      return html;
    }
    
    function addTrack() {
      theSong.push(theSong[0]);
      console.dir(theSong);
      r.create_mix(JSON.stringify(theSong));
    }

</script>
<style>
  .active {
    background-color:red;
  }
</style>
</head>
<body>
  <table id="sequencer" border="1"></table>

  <div id="transport">
    <button id="play">Play / Pause</button>
    <button id="addTrack">Add Track</button>
  </div>
  
</body>
</html>