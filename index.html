<html>
<head>
<title>JSONLoops Basic HTML / JavaScript Control Interface</title>
<link rel="stylesheet" href="lib/jquery-ui-1.8.9.custom/css/ui-lightness/jquery-ui-1.8.9.custom.css" type="text/css" media="screen" title="no title" charset="utf-8">
<script src="lib/jquery-ui-1.8.9.custom/js/jquery-1.4.4.min.js" type="text/javascript" charset="utf-8"></script>
<script src="lib/jquery-ui-1.8.9.custom/js/jquery-ui-1.8.9.custom.min.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="/dnode.js"></script>
<link rel="stylesheet" href="index.css" type="text/css" media="screen" title="no title" charset="utf-8">
<script type="text/javascript">

    var r, theSong, sounds = [], socket, connecting, playing = false, iconZoom = 100;

    $.fn.disableSelection = function() {
      $(this).attr('unselectable', 'on')
        .css('-moz-user-select', 'none')
        .each(function() { 
          this.onselectstart = function() { return false; };
      });
    };

    $(window).load(function () {
      
      connectToServer();
      
      $("body").disableSelection();
      
      $(window).resize(function() {
        $("#sounds-container-dynamic").fadeOut();
      });
      
      $("#zoom").slider({
        min: 20,
        max: 150,
        value: 100,
        slide: function(a, b) {
          $("#sounds-container-dynamic").fadeOut();
          iconZoom = b.value;          
          $("#zoomLevel").text(iconZoom);
          $("#sequencer-container img").css("zoom", iconZoom + "%");
        } 
      });
      
      $("#masterVolume").slider({
        min: 0,
        max: 100,
        value: 80,
        slide: function(a, b) {        
          $("#masterVolumeLevel").text(b.value);
          r.volume(b.value/100);
        } 
      });
      
      $("#bpm").slider({
        min: 40,
        max: 200,
        value: 180,
        slide: function(a, b) {
          $("#bpmLevel").text(b.value); // superficial update
          // Set the remote bpm
          r.bpm(b.value);
          
        },
        stop: function(a, b) {
          
          $("#bpmLevel").text(b.value);
          
        }
      });
      
      // jQuery UI events
      $('#play').click(function(){
        if (playing) {
          r.stop();
          $(this).addClass("pause");
          playing = false;
        }
        else {
          r.start();
          $(this).removeClass("pause");
          playing = true;
        }
      });
      
      $('#sounds-button').toggle(function() {
        $(this).addClass("up");
        $("#sounds-container-dynamic").fadeOut();
        $("#previews").slideDown();
      }, function() {
        $(this).removeClass("up");
        $("#sounds-container-dynamic").fadeOut();        
        $("#previews").slideUp();        
      });
      
      $('#extras-button').toggle(function() {
        $(this).addClass("up");
        $("#sounds-container-dynamic").fadeOut();
        $("#extra-controls").slideDown();
      }, function() {
        $(this).removeClass("up");
        $("#sounds-container-dynamic").fadeOut();        
        $("#extra-controls").slideUp();        
      });      
      
      $('#addTrack').click(function(){
        addTrack();
      });

      var report;

      $("#sequencer-container").scroll(function() {
        $("#sounds-container-dynamic").fadeOut();
      });

      $("#sequencer-container").live("click", function(e) {

        var note = e.target;
        if($(note).get(0).tagName !== "IMG") {
          console.log($(note).get(0).tagName);
          return false;
        }

        if(iconZoom == 100) {
          $("#sounds-container-dynamic").css({
            "top": $(note).offset().top - 31,
            "left": $(note).offset().left - 31
          }).fadeIn();          
        }
        else {
          $("#sounds-container-dynamic").css({
            "top": ($("#sequencer-container").position().top + 40),
            "left": ($("body").width()/2) - ($(note).width()/2)
          }).fadeIn();
        }

        var parent = $(note).parent();

        report = {
          track: parent.attr("data-track"),
          measure: parent.attr("data-measure"),
          beat: parent.attr("data-beat")
        };

        $('#sounds-container-dynamic').scrollTop(0);
        $('#sounds-container-dynamic').scrollTop($("#sounds-inline a[name='"+$(note)[0].name+"']").position().top - 31);

      });
      
      $("#sounds-container-dynamic a").click(function() {
        report.sound = $(this)[0].name;
        // Sync up the song
        theSong[report.track][report.measure][report.beat] = ['./wavs/' + report.sound + '.wav'];
        r.create_mix(JSON.stringify(theSong));
        $("#sounds-container-dynamic").scrollTop(0);
        $("#sounds-container-dynamic").fadeOut();
      });
      
    });

    function connectToServer() {
      socket = DNode(function () {
        this.step = function (sequencer) {
          renderSequencer(sequencer);
        };
      }).connect(function (remote) {
        playing = true;
        r = remote;
      });
    }

    function renderSequencer(sequencer) {

      theSong = sequencer.song;
      $('#sequencer tr').remove();
      var position = sequencer.position,
      cnt = 0;
      for (var t = 0; t < sequencer.song.length; t++) {
        cnt = 0;
        // Create a new row in the table for every track
        $('#sequencer').append('<tr></tr>');
        
        // Create cells for each beat in that track
        for (var m = 0; m < sequencer.song[t].length; m++) {
          for (var b = 0; b < sequencer.song[t][m].length; b++) {
            
            cnt++;
            var beat = sequencer.song[t][m][b];
            if (!beat.length) {
              beat = '';
            }
            var style = "";
            if(cnt === position + 1) {
              style = "active"; 
            }
            
            if(typeof beat != "string") {
              beat = beat[0];
            }
            
            var f = beat.substr(beat.lastIndexOf("/")+1, beat.lastIndexOf(".")-7);
            if(f == '') {
              f = 'rest';
            }

            $('#sequencer tr:last').append('<td class = "' + style + '" data-track="'+t+'" data-measure="'+m+'" data-beat="'+b+'"><img style="zoom:'+(iconZoom||'100')+'%" src="img/' + f + '.png" name="'+f+'"/></td>');
            
            var volume = Math.round(sequencer.volume*100);
            $("#bpmLevel").text(sequencer.bpm);
            $("#masterVolumeLevel").text(volume);
            $("#bpm").slider("option", "value", sequencer.bpm);
            $("#masterVolume").slider("option", "value", volume);

            // var el = $('#sequencer td.active:first');
            //            if(el.length) {
            //              $('#sequencer-container').scrollLeft((el.position().left/el.width()) * el.width())
            //            }
          }
        }
      }
    }

    function renderDropDown(active, sounds) {
      
      return active;
      var html = '';
      
      html += '<select>';
      html += '<option>' + active + '</option>';
      
      sounds.forEach(function(v, i){
        html += '<option>' + v + '</option>';
      });
      
      html += '</select>';
      
      return html;
    }
    
    function addTrack() {
      theSong.push(JSON.parse(JSON.stringify(theSong[0])));
      console.dir(theSong.length);
      r.create_mix(JSON.stringify(theSong));
    }

</script>
</head>
<body>
  <div id="transport">
    <div id="titles">
      <span id="title">New York Beat</span><br/>
      <span id="subtitle">Foobar Special</span>
    </div>
    <div id="controls">
      <button id="play" title="Play/Pause"></button>
      <button id="addTrack" title="Add Track"></button>
      <button id="sounds-button" title="Preview Sounds"></button>
      <!-- button id="extras-button" title="Extras"></button -->
      <span id="zoomLabel">Zoom <span id="zoomLevel">100</span>%</span>
      <div id="zoom"></div>
      <span id="masterVolumeLabel">Volume <span id="masterVolumeLevel">80</span></span>
      <div id="masterVolume"></div>
      <span id="bpmLabel">BPM <span id="bpmLevel">180</span></span>
      <div id="bpm"></div>            
    </div>
    <h1>JSONLoops</h1>
  </div>
  <!-- div id="extra-controls">
    <div id="extras-container">
      <table id="extras" border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class=""><img src="img/saveJSON.png" name="kick" title="Kick"></td>
            <td class=""><img src="img/uploadJSON.png" name="snare" title="Snare"></td>
            <td class=""></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div -->
  <div id="previews">
    <div id="sounds-container">
      <table id="sounds" border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class=""><img src="img/rest.png" name="rest" title="Rest"></td>
            <td class=""><img src="img/kick.png" name="kick" title="Kick"></td>
            <td class=""><img src="img/snare.png" name="snare" title="Snare"></td>
            <td class=""><img src="img/tick.png" name="tick" title="High Hat"></td>
            <td class=""><img src="img/tom.png" name="tom" title="Tom"></td>
            <td class=""><img src="img/crash.png" name="crash" title="Crash"></td>
            <td class=""><img src="img/ride.png" name="ride" title="Ride"></td>
            <td class=""><img src="img/divide.png"></td>
            <td class=""><img src="img/piano.png" name="pianorole" title="Piano Role"></td>
            <td class=""><img src="img/bell.png" name="bell" title="Cow Bell"></td>            
            <td class=""><img src="img/tamb.png" name="tambourine" title="Tambourine"></td>
            <td class=""><img src="img/bongoSmall.png" name="bongoSmall" title="Small Bongo"></td>
            <td class=""><img src="img/bongoBig.png" name="bongoBig" title="Large Bongo"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>  
  <div id="sequencer-container">
    <table id="sequencer" border="0" cellpadding="0" cellspacing="0"></table>
  </div>

  <div id="sounds-container-dynamic">
    <table id="sounds-inline" border="0" cellpadding="0" cellspacing="0">
      <tbody>
        <tr>
          <td class=""><a name="rest"><img src="img/rest.png"></a></td>
        </tr>
        <tr>
          <td class=""><a name="kick"><img src="img/kick.png"></a></td>
        </tr>
        <tr>          
          <td class=""><a name="snare"><img src="img/snare.png"></a></td>
        </tr>
        <tr>                    
          <td class=""><a name="tick"><img src="img/tick.png"></a></td>
        </tr>
        <tr>           
          <td class=""><a name="tom"><img src="img/tom.png" name="tom" title="Tom"></a></td>
        </tr>
        <tr>           
          <td class=""><a name="crash"><img src="img/crash.png" name="crash" title="Crash"></a></td>
        </tr>
        <tr>
          <td class=""><a name="ride"><img src="img/ride.png" name="ride" title="Ride"></a></td>
        </tr>
        <tr>
          <td class=""><a name="piano"><img src="img/piano.png" name="pianorole" title="Piano Role"></a></td>
        </tr>
        <tr>
          <td class=""><a name="bell"><img src="img/bell.png" name="bell" title="Cow Bell"></a></td>
        </td>        
        <tr>
          <td class=""><a name="piano"><img src="img/tamb.png" name="tambourine" title="Tambourine"></a></td>
        </td>
        <tr>
          <td class=""><a name="bongoSmall"><img src="img/bongoSmall.png" name="bongoSmall" title="Small Bongo"></a></td>
        </td>
        <tr>
          <td class=""><a name="bongoBig"><img src="img/bongoBig.png" name="bongoBig" title="Large Bongo"></a></td>        
        </td>

        
        
        
        
        
      </tbody>
    </table>
  </div>

    
</body>
</html>